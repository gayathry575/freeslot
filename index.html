
<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Free Slot Checker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 480px;
      width: 100%;
      text-align: center;
    }
    h1 { color: #0d0404; margin-bottom: 1.5rem; }
    label { display: block; margin: 0.5rem 0 0.2rem; font-weight: bold; text-align: left; }
    select, input {
      width: 100%; padding: 0.5rem; margin-bottom: 1rem;
      border: 1px solid #ccc; border-radius: 0.5rem;
    }
    button {
      width: 100%; padding: 0.7rem; background: #810c0c;
      color: white; border: none; border-radius: 0.5rem;
      font-size: 1rem; cursor: pointer;
    }
    button:hover { background: #a10f0f; }
    .result { margin-top: 1rem; padding: 0.7rem; border-radius: 0.5rem; text-align: left; }
    .free { background: #dcfce7; border: 1px solid #22c55e; }
    .occupied { background: #fee2e2; border: 1px solid #ef4444; display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .occupied-box {
      background: #fff5f5; border: 1px solid #ef4444; border-radius: 0.5rem;
      padding: 0.5rem; flex: 1 1 calc(50% - 0.5rem); box-sizing: border-box; font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="static/amrita-logo.png" alt="Amrita Logo" style="width:200px; margin-bottom:1rem;">
    <h1>Free Slot Checker</h1>

    <label for="department">Select Department</label>
    <select id="department">
      <option value="" selected disabled>Select a department</option>
    </select>

    <label for="day">Select Day</label>
    <select id="day">
      <option value="" selected disabled>Select a day</option>
      <option>Monday</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
    </select>

    <label for="time">Enter Time</label>
    <input type="text" id="time" placeholder="e.g., 8:50, 16:35"/>

    <button id="checkBtn">Check Slots</button>

    <div id="freeResult" class="result free" style="display:none;"></div>
    <div id="occupiedResult" class="result occupied" style="display:none;"></div>
  </div>

  <script type="module">
    const deptEl = document.getElementById("department");
    const dayEl = document.getElementById("day");
    const timeEl = document.getElementById("time");
    const checkBtn = document.getElementById("checkBtn");
    const freeDiv = document.getElementById("freeResult");
    const occupiedDiv = document.getElementById("occupiedResult");

    let allData = [];
    let loaded = false;

    // ðŸ‘‡ add mapping for CSV files
    const files = [
      { name: "Physics", path: "data/chemistry.csv" },
      { name: "Chemistry", path: "data/datascience.csv" },
      { name: "Data Science", path: "data/physics.csv" }
    ];

    async function loadCSVs() {
      for (let f of files) {
        try {
          const res = await fetch(f.path);
          if (!res.ok) throw new Error(`Failed to load ${f.path}`);
          const text = await res.text();
          const lines = text.split('\n').slice(1); // skip header
          lines.forEach(line => {
            if (line.trim()) {
              const [dept, block, classroom, day, slot, subject, faculty] = line.split(',').map(s => s.trim());
              allData.push({ dept, block, classroom, day, slot, subject, faculty, fileDept: f.name });
            }
          });
        } catch (err) {
          console.error(err);
        }
      }

      // fill department dropdown based on file names
      files.forEach(f => {
        const option = document.createElement("option");
        option.value = f.name;
        option.textContent = f.name;
        deptEl.appendChild(option);
      });

      loaded = true;
    }

    function parseSlotTime(ts) {
      ts = ts.replace('.', ':').toLowerCase().trim();
      const isPM = ts.includes('pm');
      const isAM = ts.includes('am');
      ts = ts.replace(/am|pm/i, '').trim();
      let [h, m] = ts.split(':').map(Number);
      if (Number.isNaN(h) || Number.isNaN(m)) return null;
      if (isPM && h < 12) h += 12;
      if (isAM && h === 12) h = 0;
      return h * 60 + m;
    }

    function isTimeInSlot(userMin, slot) {
      let [startStr, endStr] = slot.split(' - ');
      if (!startStr || !endStr) return false;
      startStr = startStr.replace(/^S/i, '').trim();
      const start = parseSlotTime(startStr);
      const end = parseSlotTime(endStr);
      if (start === null || end === null) return false;
      return userMin >= start && userMin < end;
    }

    function parseUserTime(timeStr) {
      timeStr = timeStr.replace('.', ':').trim();
      const [uh, um] = timeStr.split(':').map(Number);
      if (Number.isNaN(uh) || Number.isNaN(um)) throw new Error('Invalid time format');
      const userMin = uh * 60 + um;
      if (userMin < 8*60+50 || userMin > 16*60+35) throw new Error('Enter timing between 8:50 - 16:35 only');
      return userMin;
    }

    checkBtn.addEventListener("click", async () => {
      const dept = deptEl.value;
      const day = dayEl.value;
      const time = timeEl.value.trim();
      if (!dept) { alert("Select department"); return; }
      if (!time) { alert("Enter a time (e.g., 8:50, 16:35)"); return; }

      freeDiv.style.display = "none";
      occupiedDiv.style.display = "none";
      checkBtn.textContent = "Checking...";

      try {
        if (!loaded) await loadCSVs();
        const userMin = parseUserTime(time);

        // filter records for this dept + day
        const deptData = allData.filter(entry => entry.fileDept === dept && entry.day === day);

        // Handle break time
        const breakStart = 10*60 + 30;
        const breakEnd = 10*60 + 45;
        if (userMin >= breakStart && userMin < breakEnd) {
          freeDiv.innerHTML = "â° Break Period";
          freeDiv.style.display = "block";
          occupiedDiv.innerHTML = "No occupied slots.";
          occupiedDiv.style.display = "block";
          checkBtn.textContent = "Check Slots";
          return;
        }

        // Free classrooms
        const freeClassrooms = deptData
          .filter(entry => isTimeInSlot(userMin, entry.slot) && (!entry.subject || entry.subject.trim() === ""))
          .map(entry => `${entry.block} - ${entry.classroom}`);

        // Occupied classrooms
        const occupiedDetails = deptData
          .filter(entry => isTimeInSlot(userMin, entry.slot) && entry.subject && entry.subject.trim() !== "" && entry.subject.toLowerCase() !== "break")
          .map(entry => ({
            block: entry.block,
            classroom: entry.classroom,
            subject: entry.subject,
            faculty: entry.faculty
          }));

        freeDiv.innerHTML = freeClassrooms.length > 0 ?
          `<strong>Free Slots:</strong><br/>${[...new Set(freeClassrooms)].join("<br/>")}` :
          "No free slots available.";
        freeDiv.style.display = "block";

        if (occupiedDetails.length > 0) {
          const occupiedHtml = occupiedDetails.map(d =>
            `<div class="occupied-box">
              <strong>Block:</strong> ${d.block}<br/>
              <strong>Classroom:</strong> ${d.classroom}<br/>
              <strong>Course:</strong> ${d.subject}<br/>
              <strong>Faculty:</strong> ${d.faculty}
            </div>`
          ).join("");
          occupiedDiv.innerHTML = occupiedHtml;
        } else {
          occupiedDiv.innerHTML = "No occupied slots.";
        }
        occupiedDiv.style.display = "flex";

      } catch (err) {
        alert(err.message || "Error processing data.");
        console.error(err);
      } finally {
        checkBtn.textContent = "Check Slots";
      }
    });

    loadCSVs();
  </script>
</body>
</html>
